<!DOCTYPE html>
<html>
  <head>
    <!-- Basic -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Mobile Metas -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- Site Metas -->
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />

    <title>Giftos</title>

    <!-- Icon Font Stylesheet -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- slider stylesheet -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"
    />

    <!-- bootstrap core css -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css" />
    <!--  croper  to crop images-->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.css"
    />
    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet" />
    <link href="css/adminstyle.css" rel="stylesheet" />
    <!-- responsive style -->
    <link href="css/responsive.css" rel="stylesheet" />
    <style>
      .error-message {
        color: red;
      }

      .thumbnails-container {
        display: flex;
        overflow-x: auto;
      }

      .thumbnail {
        margin-right: 10px;
      }
      .thumbnails-container img {
        max-width: 100%; /* Ensures the image doesn't exceed the container's width */
        max-height: 100%; /* Ensures the image doesn't exceed the container's height */
        object-fit: contain; /* Ensures the image maintains its aspect ratio */
      }

      .image-cropper img {
        width: 100%; /* Shrink the image to fit the cropper's width */
        height: 100%; /* Shrink the image to fit the cropper's height */
        object-fit: cover; /* Maintain aspect ratio and fill the cropper */
      }

    </style>
  </head>

  <body>
    <div class="adminhero_area">
      <!-- header section strats -->
      <header class="header_section">
        <nav class="navbar navbar-expand-lg custom_nav-container">
          <p class="header_giftos">
            <a class="navbar-brand" href="/">
              <span> Giftos </span>
            </a>
          </p>
          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class=""></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav">
              <li class="nav-item active">
                <a class="nav-link" href="http://localhost:4000/admin/adminHome"
                  >Home <span class="sr-only">(current)</span></a
                >
              </li>
            </ul>
            <div class="user_option">
              <% if (sessionName) { %>
              <ul class="navbar-navuser">
                <li class="navuser-item user-dropdown">
                  <i
                    class="fa fa-user"
                    id="user-name"
                    style="font-size: larger"
                  ></i>
                  <ul class="dropdown-menu" id="dropdown-menu">
                    <!-- <li><a href="/admin-profile">Profile</a></li> -->
                    <li>
                      <a href="#" id="logout">Logout</a>
                    </li>
                  </ul>
                </li>
              </ul>
              <% } else { %>

              <ul class="navbar-navuser">
                <li class="navuser-item user-dropdown">
                  <i class="fa fa-user" id="user-icon"></i>
                  <!-- <ul class="dropdown-menu" id="dropdown-menu">
                    <li><a href="/user-profile">User Profile</a></li>
                    <li><a href="/address-book">Address Book</a></li>
                    <li><a href="/logout">Logout</a></li>
                  </ul> -->
                </li>
              </ul>

              <a href="/login">
                <span> Login </span>
              </a>

              <% } %>
              <!-- 
             <a href="">
               <i class="fa fa-shopping-bag" aria-hidden="true"></i>
             </a>
             <a href="">
               <i class="fa fa-heart" aria-hidden="false"></i>
             </a> -->
              <!-- <form class="form-inline ">
               <button class="btn nav_search-btn" type="submit">
                 <i class="fa fa-search" aria-hidden="true"></i>
               </button>
             </form> -->
            </div>
          </div>
        </nav>
      </header>
    </div>
    <!-- end header section -->
    <div class="container-xxl position-relative bg-white d-flex p-0">
      <!-- Sidebar Start -->
      <div class="sidebar pe-4 pb-3 bg-light">
        <nav class="navbar navbar-light">
          <div class="d-flex align-items-center ms-4 mb-4">
            <div class="position-relative d-flex align-items-center">
              <img
                class="rounded-circle"
                src="images/admin.img/user.jpg"
                alt=""
                style="width: 40px; height: 40px"
              />
              <div
                class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1"
              ></div>
            </div>
            <div class="ms-3">
              <h6 class="mb-0">Thanveer</h6>
              <span>Admin</span>
            </div>
          </div>
          <div class="navbar-nav w-100">
            <a
              href="http://localhost:4000/admin/adminHome"
              class="nav-item nav-link active"
              ><i class="fa fa-tachometer-alt me-2"></i>Dashboard</a
            >
            <!-- {{!-- <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown"><i
                                class="fa fa-laptop me-2"></i>PRODUCT LIST</a>
                        <div class="dropdown-menu bg-transparent border-0">
                            <a href="button.html" class="dropdown-item">Buttons</a>
                            <a href="typography.html" class="dropdown-item">Typography</a>
                            <a href="element.html" class="dropdown-item">Other Elements</a>
                        </div>
                    </div> --}} -->
            <a href="/admin/productList" class="nav-item nav-link"
              ><i class="fa fa-th me-2"></i>PRODUCT LIST</a
            >
            <a href="/admin/userlist" class="nav-item nav-link"
              ><i class="fa fa-th me-2"></i>USER LIST</a
            >
            <a href="/admin/orderlist" class="nav-item nav-link"
              ><i class="fa fa-table me-2"></i>ORDER LIST</a
            >
            <a href="/admin/category" class="nav-item nav-link"
              ><i class="fa fa-table me-2"></i>CATEGORY</a
            >
            <a href="/admin/coupenadmin" class="nav-item nav-link"
              ><i class="fa fa-table me-2"></i>COUPEN</a
            >
            <a href="/admin/salesreport" class="nav-item nav-link"
              ><i class="fa fa-chart-bar me-2"></i>SALES REPORT</a
            >
            <a href="/banner" class="nav-item nav-link"
              ><i class="fa fa-table me-2"></i>BANNER</a
            >
            <!-- {{!-- <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown"><i
                                class="far fa-file-alt me-2"></i>Pages</a>
                        <div class="dropdown-menu bg-transparent border-0">
                            <a href="signin.html" class="dropdown-item">Sign In</a>
                            <a href="signup.html" class="dropdown-item">Sign Up</a>
                            <a href="404.html" class="dropdown-item">404 Error</a>
                            <a href="blank.html" class="dropdown-item">Blank Page</a>
                        </div>
                    </div> --}} -->
          </div>
        </nav>
      </div>

      <!-- Content Start -->
      <div class="content">
        <section class="content-main">
          <div class="row">
            <div class="col-12">
              <div class="content-header">
                <h2 class="content-title">Add New Product</h2>
              </div>
            </div>
            <div class="col-lg-12">
              <form
                method="post"
                action="/product/addproduct"
                enctype="multipart/form-data"
                onsubmit="return validateForm()"
              >
                <div class="row align-items-start">
                  <div class="col-lg-5 card mb-4">
                    <div class="card-body">
                      <div class="mb-4">
                        <label for="product_name" class="form-label"
                          >Product Name</label
                        >
                        <input
                          type="text"
                          placeholder="Type here"
                          name="productName"
                          class="form-control border"
                          id="product_name"
                        />
                        <div id="productName-error" class="error-message"></div>
                      </div>

                      <div class="mb-4">
                        <label class="form-label">Full description</label>
                        <textarea
                          placeholder="Type here"
                          id="descriptionid"
                          name="description"
                          class="form-control border"
                          rows="4"
                        ></textarea>
                        <div id="description-error" class="error-message"></div>
                      </div>
                      <div class="row">
                        <div class="col-lg-4">
                          <div class="mb-4">
                            <label class="form-label">Regular price</label>
                            <input
                              placeholder="$"
                              name="regularPrice"
                              type="text"
                              class="form-control border"
                            />
                            <div
                              id="regularPrice-error"
                              class="error-message"
                            ></div>
                          </div>
                        </div>
                        <div class="col-lg-4">
                          <div class="mb-4">
                            <label class="form-label">Sale price</label>
                            <input
                              placeholder="$"
                              name="salePrice"
                              type="text"
                              class="form-control border"
                            />
                          </div>
                          <div id="salePrice-error" class="error-message"></div>
                        </div>
                        <div class="col-lg-4">
                          <div class="mb-4">
                            <label class="form-label">Stock</label>
                            <input
                              placeholder=""
                              name="stock"
                              type="text"
                              class="form-control border"
                            />
                            <div id="stock-error" class="error-message"></div>
                          </div>
                        </div>
                        <div class="col-lg-4">
                          <div class="mb-4">
                            <label class="form-label">Max Per Person</label>
                            <input
                              placeholder=""
                              name="maxPerPerson"
                              type="text"
                              class="form-control border"
                            />
                            <div id="maxPerPerson" class="error-message"></div>
                          </div>
                        </div>
                      </div>

                      <div class="card mb-4">
                        <div class="card-body">
                          <div class="row gx-2">
                            <div class="col-sm-6 mb-3">
                              <label class="form-label">Category</label>
                              <select
                                class="form-select border"
                                style="width: 150px"
                                name="category"
                              >
                                <% category.forEach((cat)=>{ %>

                                <option value="<%= cat.Category %>">
                                  <%= cat.Category %>
                                </option>
                                <% }) %>
                              </select>
                              <div
                                id="category-error"
                                class="error-message"
                              ></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- </div>
                        <div class="row"> -->
                  <div class="col-lg-6 ml-3 card mb-4">
                    <div class="card-body">
                      <div class="card mb-2">
                        <div class="card-header">
                          <h4 class="text-center">Choose images</h4>
                        </div>
                        <div class="border row">
                          <div
                            id="addedImagesContainer"
                            class="thumbnails-container"
                          ></div>
                        </div>
                        <div class="row">
                          <div
                            class="card-body align-items-center"
                            style="margin-bottom: 20px"
                          >
                            <img src="" alt="" id="imgView1" />
                            <input
                              class="form-control"
                              type="file"
                              name="images"
                              id="input1"
                              accept="image/png, image/jpeg, image/jpg"
                              onchange="viewImage1(event), viewImage(event, 1)"
                            />
                            <div id="images-error" class="error-message"></div>
                          </div>
                          <div
                            class="image-cropper d-flex align-items-center"
                            style="
                              display: none;
                              width: 250px;
                              height: 200px;
                              margin-bottom: 20px;
                              overflow: hidden;
                            "
                          >
                            <img src="" id="croppedImg1" alt="" />
                            <button
                              type="button"
                              id="saveButton1"
                              class="btn-sm btn-primary"
                            >
                              Save
                            </button>
                          </div>
                        </div>

                        <div class="row">
                          <div
                            class="card-body align-items-center"
                            style="margin-bottom: 20px"
                          >
                            <img src="" alt="" id="imgView2" />

                            <input
                              class="form-control"
                              type="file"
                              name="images"
                              id="input2"
                              accept="image/png, image/jpeg, image/jpg"
                              onchange="viewImage2(event),viewImage(event, 2)"
                            />
                          </div>
                          <div
                            class="image-cropper d-flex align-items-center"
                            style="
                              display: none;
                              width: 250px;
                              height: 200px;
                              margin-bottom: 20px;
                            "
                          >
                            <img src="" id="croppedImg2" alt="" />
                            <button
                              type="button"
                              id="saveButton2"
                              class="btn-sm btn-primary"
                            >
                              Save
                            </button>
                          </div>
                        </div>

                        <div class="row">
                          <div
                            class="card-body align-items-center"
                            style="margin-bottom: 20px"
                          >
                            <img src="" alt="" id="imgView3" />

                            <input
                              class="form-control"
                              type="file"
                              name="images"
                              id="input3"
                              accept="image/png, image/jpeg, image/jpg"
                              onchange="viewImage3(event),viewImage(event, 3)"
                            />
                          </div>
                          <div
                            class="image-cropper d-flex align-items-center"
                            style="
                              display: none;
                              width: 250px;
                              height: 200px;
                              margin-bottom: 20px;
                            "
                          >
                            <img src="" id="croppedImg3" alt="" />
                            <button
                              type="button"
                              id="saveButton3"
                              class="btn-sm btn-primary"
                            >
                              Save
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div>
                      <button
                        class="btn btn-primary rounded font-sm hover-up"
                        type="button"
                        onclick="validateAndSubmit()"
                      >
                        Publish
                      </button>
                    </div>
                  </div>
                                
               </div>
              </form>
            </div>
          </div>
          <!-- </div> -->
        </section>
      </div>
    </div>
    <!-- footer -->
    <footer class="footer_section">
      <div class="container">
        <p>
          &copy; <span id="displayYear"></span> All Rights Reserved By
          <a href="#">GIFTOS</a>
        </p>
      </div>
    </footer>

    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>

    <script src="javascript/addProductDetails.js"></script>
    <script src="js/custom.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/admin/confirmLogout.js" defer></script>

    <script>
      function validateAndSubmit() {
        if (validateForm()) {
          console.log(
            "form is validate==================================================================="
          );

          document.forms[0].submit();
        }
      }

      function viewImage1(event) {
        document.getElementById("imgView1").src = URL.createObjectURL(
          event.target.files[0]
        );
      }

      function viewImage2(event) {
        document.getElementById("imgView2").src = URL.createObjectURL(
          event.target.files[0]
        );
      }

      function viewImage3(event) {
        document.getElementById("imgView3").src = URL.createObjectURL(
          event.target.files[0]
        );
      }

      // function viewImage(event, index) {
      //   let input = event.target;
      //   console.log("reached viewImage fucntion", event.target, input);
      //   let reader = new FileReader();
      //   reader.onload = () => {
      //     let dataURL = reader.result;
      //     let image = document.getElementById(`imgView${index}`);
      //     image.src = dataURL;
      //     image.style.maxWidth = "100%", 
      //       image.style.maxHeight = "300px", 
      //       image.style.objectFit = "contain" 
      //     let cropper = new Cropper(image, {
      //       aspectRatio: 1,
      //       viewMode: 1,
      //       guides: true,
      //       background: false,
      //       autoCropArea: 1,
      //       zoomable: true,
      //     });
      //     console.log("cropper " + cropper);
      //     let corpperContainer = document.querySelector(
      //       "#croppedImg" + index
      //     ).parentNode;
      //     corpperContainer.style.display = "block";

      //     let saveButton = document.querySelector("#saveButton" + index);
      //     saveButton.addEventListener("click", async function () {
      //       let croppedCanvas = cropper.getCroppedCanvas();
      //       let croppedImage = document.getElementById("croppedImg" + index);
      //       croppedImage.src = croppedCanvas.toDataURL("image/jpeg", 1.0);

      //       let timestamp = new Date().getTime();
      //       let fileName = `cropped-img-${timestamp}-${index}.png`;

      //       await croppedCanvas.toBlob((blob) => {
      //         let input = document.getElementById("input" + index);
      //         let imgFile = new File([blob], fileName, blob);
      //         const fileList = new DataTransfer();
      //         fileList.items.add(imgFile);
      //         input.files = fileList.files;
      //       });

      //       corpperContainer.style.display = "none";
      //       cropper.destroy();
      //     });
      //   };

      //   reader.readAsDataURL(input.files[0]);
      // }

    function viewImage(event, index) {
      const input = event.target;
      const image = document.getElementById(`imgView${index}`);
      const cropperContainer = document.querySelector(`#croppedImg${index}`).parentNode;
      const saveButton = document.querySelector(`#saveButton${index}`);
      const reader = new FileReader();

      reader.onload = () => {
        image.src = reader.result;
        image.style.display = "block"; // Make image visible
        image.style.maxWidth = "100%";
        image.style.maxHeight = "300px";
        image.style.objectFit = "contain";

        cropperContainer.style.display = "flex";

        const cropper = new Cropper(image, {
          aspectRatio: 1, // 1:1 aspect ratio for a square crop
          viewMode: 2, // Ensure the entire image is visible in the container
          guides: true,
          background: false,
          autoCropArea: 1, // Set to 1 to cover the entire image initially
          zoomable: true,
          scalable: true,
          cropBoxResizable: true, // Allow resizing of the crop box
          cropBoxMovable: true,   // Allow moving of the crop box
          responsive: true,
          ready() {
            // Ensure the crop box starts by covering the entire image
            const containerData = cropper.getContainerData();
            const cropBoxData = cropper.getCropBoxData();
            cropper.setCropBoxData({
              left: 0,
              top: 0,
              width: containerData.width,
              height: containerData.height,
            });
          },
        });

        saveButton.addEventListener("click", async () => {
          const croppedCanvas = cropper.getCroppedCanvas({
            width: 250,
            height: 250,
          });

          const croppedImage = document.getElementById(`croppedImg${index}`);
          croppedImage.src = croppedCanvas.toDataURL("image/jpeg", 1.0);

          const timestamp = new Date().getTime();
          const fileName = `cropped-img-${timestamp}-${index}.png`;

          await croppedCanvas.toBlob((blob) => {
            const input = document.getElementById(`input${index}`);
            const imgFile = new File([blob], fileName, { type: blob.type });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(imgFile);
            input.files = dataTransfer.files;
          });

          cropperContainer.style.display = "none";
          cropper.destroy();
        });
      };

      reader.readAsDataURL(input.files[0]);
    }


      function validateForm() {
        clearErrorMessages();
        const name = document.getElementById("product_name").value;
        const description = document.getElementById("descriptionid").value;
        const price = document.getElementsByName("regularPrice")[0].value;
        const saleprice = document.getElementsByName("salePrice")[0].value;
        const category = document.getElementsByName("category")[0].value;
        const images = document.getElementById("input1");
        const stock = document.getElementsByName("stock")[0].value;
        const maxPerPerson =document.getElementsByName("maxPerPerson")[0].value;
        let isValid = true;
        if (name.trim() === "") {
          displayErrorMessage(
            "productName-error",
            "Please enter a product name."
          );
          isValid = false;
        } else if (!/^[a-zA-Z\s]+$/.test(name.trim())) {
          displayErrorMessage(
            "productName-error",
            "Product name should contain only alphabetic characters."
          );
          isValid = false;
        }

        if (description.trim() === "") {
          displayErrorMessage(
            "description-error",
            "Please enter a product description."
          );
          isValid = false;
        }
        //  else if (!/^[a-zA-Z\s]+$/.test(description.trim())) {
        // displayErrorMessage('description-error', 'Product description should contain only alphabetic characters.');
        // isValid = false;
        // }

        if (parseInt(stock) < 0 || !parseInt(stock)) {
          displayErrorMessage(
            "stock-error",
            "Please enter a valid non-negative quantity."
          );
          isValid = false;
        }

        if (parseInt(maxPerPerson) < 0 || !parseInt(maxPerPerson)){
          displayErrorMessage(
            "maxPerPerson",
            "Please enter a valid non-negative quantity."
          );
          isValid = false;
        }

        if (!/^\d+(\.\d{1,2})?$/.test(price) || parseFloat(price) < 0) {
          displayErrorMessage(
            "regularPrice-error",
            "Please enter a valid non-negative price."
          );
          isValid = false;
        }

        if (parseFloat(price) <= parseFloat(saleprice)) {
          displayErrorMessage(
            "regularPrice-error",
            "Regular price must be greater than sale price."
          );
          isValid = false;
        }

        if (images.files.length === 0) {
          displayErrorMessage("images-error", "Please select an image.");
          isValid = false;
        }
        return isValid;
      }

      function displayErrorMessage(elementId, message) {
        var errorElement = document.getElementById(elementId);
        errorElement.innerText = message;
        errorElement.style.display = "block";
      }

      function clearErrorMessages() {
        const errorElements = document.getElementsByClassName("error-message");
        Array.from(errorElements).forEach((element) => {
          element.innerText = "";
        });
        const errorMessage = document.getElementById("errorMessage");
      }
    </script>
  </body>
</html>

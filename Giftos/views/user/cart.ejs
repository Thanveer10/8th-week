<!DOCTYPE html>
<html>
  <head>
    <!-- Basic -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Mobile Metas -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- Site Metas -->
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />

    <title>Giftos</title>

    <!-- slider stylesheet -->
    <!-- <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" /> -->

    <!-- bootstrap core css -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css" />

    <!-- font awsome  -->
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"> -->

    <!-- Custom styles for this template -->
    <link href="/css/style.css" rel="stylesheet" />

    <!-- responsive style -->
    <link href="/css/responsive.css" rel="stylesheet" />

    <!-- product detials css -->
    <link rel="stylesheet" href="/css/productDetails.css" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        padding-top: 170px;
        height: 100vh;
        
        /* Adjust the value to match your navbar height */
      }
/* .cart-area{
  height: 100vh;
  width: 100vw;
  background-color: rgb(209, 202, 202);
} */
      .cart-item {
        border: 1px solid #f1f1f1;
        border-radius: 8px;
        padding: 20px 15px;
        margin-bottom: 55px;
      }

      .cart-total {
        /* border: 1px solid #007bff; */
        background-color: #fefeff;
        border: 3px solid #f1f1f1;
        border-radius: 8px;
        padding: 20px 15px;
        margin-top: 30px;
        border-radius: 8px;
        padding: 20px;
      }

      .cart-total h5,
      .cart-total h6 {
        margin: 0 0 15px;
      }

      .btn-delete {
        color: #dc3545;
        cursor: pointer;
      }

      .btn-delete:hover {
        color: #a71d2a;
      }
     span.order-summery{
       font-size: 20px;
       /* font-weight: bold; */
       margin-bottom: 16px;
       margin-left: 15px !important;
     }
     span.text-success{
      font-weight: bolder !important;;
     }
      .checkout-btn {
        background-color: #f8d7da;
        color: #dc3545;
        border: none;
      }

      .checkout-btn:hover {
        background-color: #f5c2c7;
        color: #a71d2a;
      }

      /* coupen code */
      /* Coupon Container Styling */
      .flex-w {
        max-width: 500px;
        /* Set your desired width */
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 15px;
        padding: 18px 25px;
        background: linear-gradient(145deg, #ffffff, #f0f0f0);
        box-shadow: 3px 3px 8px #b0b0b0, -3px -3px 8px #ffffff;
      }

      /* Input Field Styling */
      input[type="text"] {
        padding: 10px 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        outline: none;
        width: 220px;
        transition: all 0.3s ease;
      }

      input[type="text"]:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
      }

      /* Button Styling */
      button {
        padding: 10px 1rem;
        border: none;
        border-radius: 8px;
        background-color: #ecbfc2;
        color: #dc3545;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      button:hover {
        background-color: #e0979f;
        color: #a71d2a;
      }

      /* Success and Error Messages */
      h5 {
        margin-top: 10px;
        font-size: 14px;
      }

      h5[style="color: red;"] {
        color: #dc3545;
        font-weight: bold;
      }

      h5[style="color: green;"] {
        color: #28a745;
        font-weight: bold;
      }

      /* Responsive Adjustments */
      @media (max-width: 998px) {
        .flex-w {
          max-width: 380px !important;
          flex-direction: column;
          padding: 10px 30px;
          margin-top: 20px !important;
          margin: auto;
        }

        input[type="text"] {
          width: 100%;
          margin-bottom: 10px;
        }

        button {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <div class="hero_area">
      <!-- header section strats -->
      <header class="header_section">
        <nav class="navbar navbar-expand-lg custom_nav-container">
          <p class="header_giftos">
            <a class="navbar-brand" href="/">
              <span> Giftos </span>
            </a>
          </p>
          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class=""></span>
          </button>

          <div
            class="collapse navbar-collapse innerpage_navbar"
            id="navbarSupportedContent"
          >
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" href="/"
                  >Home <span class="sr-only">(current)</span></a
                >
              </li>
              <li class="nav-item active">
                <a class="nav-link" href="/shop"> Shop </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/whyUs"> Why Us </a>
              </li>
              <!-- <li class="nav-item">
                    <a class="nav-link" href="/testimonial">
                        Testimonial
                    </a>
                    </li> -->
              <li class="nav-item">
                <a class="nav-link" href="/contact">Contact Us</a>
              </li>
            </ul>
            <div class="user_option">
              <% if (sessionName) { %>
              <ul class="navbar-navuser">
                <li class="navuser-item user-dropdown">
                  <i class="fa fa-user" id="user-icon"></i>
                  <ul class="dropdown-menu" id="dropdown-menu">
                    <li><a href="/user-profile">User Profile</a></li>
                    <li><a href="/address-book">Address Book</a></li>
                    <li><a href="/order-details">Order Details</a></li>
                    <li><a href="/setting">Setting</a></li>
                    <form
                      id="logout-form"
                      method="post"
                      action="/logout"
                      style="display: inline"
                    >
                      <button type="submit" class="logout-btn">Logout</button>
                    </form>
                  </ul>
                </li>
              </ul>
              <% } else { %>

              <ul class="navbar-navuser">
                <li class="navuser-item user-dropdown">
                  <i class="fa fa-user" id="user-icon"></i>
                  <!-- <ul class="dropdown-menu" id="dropdown-menu">
                            <li><a href="/user-profile">User Profile</a></li>
                            <li><a href="/address-book">Address Book</a></li>
                            <li><a href="/logout">Logout</a></li>
                        </ul> -->
                </li>
              </ul>

              <a href="/login">
                <span> LogIn </span>
              </a>
              <% } %>

              <a href="/adduserCart">
                <i class="fa fa-shopping-bag" aria-hidden="true"></i>
              </a>

              <a href="/wishlist">
                <i class="fa fa-heart" aria-hidden="false"></i>
              </a>
            </div>
          </div>
        </nav>
      </header>
      <!-- end header section -->
    </div>
    <!-- end hero area -->
      
    <!-- contend start session-->
    <div class="container mt-5 cart-area">
      <%if(productCart.length > 0){ %>
      <div class="row border-top-0">
        <!-- Cart Items Section -->
        <div class="col-lg-8">
          <h4 class="mb-3">Shopping cart</h4>
          <p class="text-muted">
            You have <strong> <%= productCart.length %> </strong> type of
            product in your cart
          </p>
          <% productCart.forEach(cartProduct=>{ %>

          <!-- Cart Item 1 -->
          <div
            class="cart-item d-flex justify-content-between align-items-center"
          >
            <div class="d-flex align-items-center">
              <img
                src="/productsimg/<%= cartProduct.Product.Productimage[0] %>"
                alt="Product Image"
                class="me-3"
                width="70"
              />
              <div>
                <h4 style="font-weight:bold" class="mb-1 "><%= cartProduct.Product.Productname %></h4>
                 <p style="display: inline;" class="text-muted mb-0" id="regularPrice-<%= cartProduct.item %>">  <strong>Total Price :</strong> <i
                  class="fa-solid fa-indian-rupee-sign"
                  style="font-size: small; padding-left: 5px; color: #858b85"
                ></i>  <%= cartProduct.subTotal.toFixed(2) %></p>
                 <p  class="text-muted mb-0" id="discountValue-<%= cartProduct.item %>"> <strong>Discount :</strong> <i
                  class="fa-solid fa-indian-rupee-sign"
                  style="font-size: small; padding-left: 5px; color: #858b85"
                ></i>  <%= cartProduct.totaDiscValue.toFixed(2) %></p>
                 <strong>Final Price :</strong> <p style="display: inline;" class="text-muted mb-0" id="totalPrice-<%= cartProduct.item %>">
                  <i
                  class="fa-solid fa-indian-rupee-sign"
                  style="font-size: small; padding-left: 5px; color: #282928"
                ></i> 
                  <%= cartProduct.totalPrice.toFixed(2) %>
                </p>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <button
                class="btn btn-outline-secondary btn-sm me-2"
                onclick="updateCart( '<%= cartProduct.item %>',-1)"
              >
                <i class="fas fa-minus"></i>
              </button>
              <span id="quantity-<%= cartProduct.item %>">
                <%= cartProduct.quantity %>
              </span>
              <button
                class="btn btn-outline-secondary btn-sm ms-2"
                onclick="updateCart('<%= cartProduct.item %>',1,' <%= cartProduct.Product.Stock %>',' <%= cartProduct.Product.MaxPerPerson %>')"
              >
                <i class="fas fa-plus"></i>
              </button>
<!-- 
              <p class="ms-4 mb-0" id="totalPrice-<%= cartProduct.item %>">
                <%= cartProduct.totalPrice.toFixed(2) %>
              </p> -->
              <a  onclick="confirmDelete('<%= cartProduct.item %>')"

                style="text-decoration: none; color: #686363; font-size: small"
              >
                <i
                  class="fas fa-trash-alt btn-delete ms-4"
                  ></i>
                  
                REMOVE</a
              >
            </div>
          </div>
          <% }) %>
        </div>
        <!-- </div> -->

        <div class="col-lg-4">
          <div class="cart-total pl-4 pr-4 card shadow-sm">
            <h4 style="font-weight: bold; margin-bottom: 16px;;">ORDER SUMMARY</h4>
            <h6 class="d-flex justify-content-between align-items-center">
              <span class="order-summery">Toatal Products:</span>
              <span class="text-success" id="totalquant">
                <%= totalQuantity %>
              </span>
            </h6>
            <h6 class="d-flex justify-content-between align-items-center">
              <span class="order-summery ">Sub Total:</span>
              <span class="text-success " id="subtotal"><i
                class="fa-solid fa-indian-rupee-sign"
                style="font-size: medium; padding-left: 5px; color: #28a745"
              ></i>
               <%= sub_total.toFixed(2) %> </span>
            </h6>
            <h6 class="d-flex justify-content-between align-items-center">
              <span class="order-summery">DiscountPrice:</span>
              <span class="text-success" id="totalDiscountValue">
                <i
                class="fa-solid fa-indian-rupee-sign"
                style="font-size: medium; padding-left: 5px; color: #28a745"
              ></i>
                <%= discountValue.toFixed(2) %>
              </span>
            </h6 >
            <h6 class="d-flex justify-content-between align-items-center">
              <span class="order-summery">Final Amount:</span>
              <span style="font-size: medium" class="text-success grandTotal ">
                <i
                class="fa-solid fa-indian-rupee-sign"
                style="font-size: medium; padding-left: 5px; color: #28a745"
              ></i>
                <%= grand_total.toFixed(2) %>
              </span>
            </h6>
            <button
              class="btn checkout-btn w-100 mt-4 "
              onclick="location.href='/checkout'"
            >
              <!-- <span class="grandTotal"> <%= grand_total.toFixed(2) %> </span> -->
              Proceed To Checkout <i class="fas fa-arrow-right"></i>
            </button>
          </div>
          


        </div>

        <!-- Cart Summary Section -->
      </div>
     <% } else { %>
      <div class="heading_container heading_center">
      <h2 style="text-transform: none; color: rgb(209, 53, 53);"> 
        Oops!
        <h6>Your Cart Is Look Empty.</h6>
      </h2>
      <div class="mt-5">
        <button class=" btn btn-danger " onclick="goaback()">go back</button>
      </div>
     </div>
       <% } %>
    </div>

    <!-- contend end sessioon -->

    <!-- info section -->

    <!-- <section class="info_section  layout_padding2-top">
            <div class="social_container">
            <div class="social_box">
                <a href="">
                <i class="fa fa-facebook" aria-hidden="true"></i>
                </a>
                <a href="">
                <i class="fa fa-twitter" aria-hidden="true"></i>
                </a>
                <a href="">
                <i class="fa fa-instagram" aria-hidden="true"></i>
                </a>
            
            </div>
            </div> 
            <div class="info_container ">
            <div class="container">
                <div class="row">
                <div class="col-md-6 col-lg-3">
                    <h6>
                    ABOUT US
                    </h6>
                    <p>
                    "We specialize in curating thoughtful gifts for every occasion, whether it's birthdays, anniversaries, or just because.
                    </p>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="info_form ">
                    <h5>
                        Newsletter
                    </h5>
                    <form action="#">
                        <input type="email" placeholder="Enter your email">
                        <button>
                        Subscribe
                        </button>
                    </form>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <h6>
                    NEED HELP
                    </h6>
                    <p>
                    Track Order
                    </p>
                    <p></p>
                    Return
                    </p>
                    <p></p>
                    Shipping
                    </p>
                    <p></p>
                    FAQs
                    </p>
                </div>
                <div class="col-md-6 col-lg-3">
                    <h6>
                    CONTACT US
                    </h6>
                    <div class="info_link-box">
                    <a href="">
                        <i class="fa fa-map-marker" aria-hidden="true"></i>
                        <span> Tirur Road, Malappuam,Kerala </span>
                    </a>
                    <a href="">
                        <i class="fa fa-phone" aria-hidden="true"></i>
                        <span>++91 8590847332</span>
                    </a>
                    <a href="">
                        <i class="fa fa-envelope" aria-hidden="true"></i>
                        <span> vvjy@gmail.com</span>
                    </a>
                    </div>
                </div>
                </div>
            </div>
            </div> 
            
            <footer class=" footer_section">
            <div class="container">
                <p>
                &copy; <span id="displayYear"></span> All Rights Reserved By
                <a href="#">GIFTOS</a>
                </p>
            </div>
            </footer>
            

        </section>  -->

    <!-- end info section -->
    <script>
      document
        .getElementById("logout-form")
        .addEventListener("submit", (event) => {
          if (!confirm("Are you sure, You  really want to  log out? ")) {
            event.preventDefault();
          }
        });

        function goaback(){
          window.history.back();
         }
    </script>
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <script src="/js/custom.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      //update cart
      function updateCart(productId, change, stock, MaxPerPerson) {
        setTimeout(() => {
          try {
            console.log(
              "================================================reached the updtecart======================================"
            );
            console.log("attributes: " + productId, change);

            const quantityElement = document.querySelector(
              `#quantity-${productId}`
            );
            const currentQuantity = parseInt(quantityElement.innerText);

            // Prevent decrementing below 1
            if (currentQuantity === 1 && change === -1) {
              Swal.fire({
                title: "Invalid Quantity",
                text: "Quantity cannot be less than 1.",
                icon: "error",
                confirmButtonText: "OK",
              });
              return;
            }

            if (currentQuantity >= stock) {
              Swal.fire({
                title: "Stock Limit Reached",
                text: `Only ${stock} items available for this product. You can't add more than ${stock}.`,
                icon: "warning",
                confirmButtonText: "OK",
              });
              return;
            }

            if (currentQuantity >= MaxPerPerson) {
              Swal.fire({
                title: "Limit Per Person",
                text: `You have already added ${MaxPerPerson} items for this product. You can't add more than ${MaxPerPerson}.`,
                icon: "info",
                confirmButtonText: "OK",
              });
              return;
            }

            const response = fetch("/cart/update", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify({ productId, change }),
            })
              .then((response) => {
                console.log(
                  "response status in fetch api for update cart" +
                    response.status
                );

                if (!response.ok) {
                  return response.json().then((errorData) => {
                    // Show SweetAlert error modal
                    Swal.fire({
                      icon: "error",
                      title: "Session Expired",
                      text: "Please log in again to continue.",
                      showCancelButton: true, // Show the Cancel button
                      confirmButtonText: "Go to Login", // Text for the confirm button
                      cancelButtonText: "Stay Here", // Text for the cancel button
                      reverseButtons: true, // Text for the cancel button
                    }).then((result) => {
                      if (result.isConfirmed) {
                        window.location.href = "/login";
                      } else if (
                        result.dismiss === Swal.DismissReason.cancell
                      ) {
                        console.log("User chose to stay on the page");
                      }
                    });
                    throw new Error(errorData.message); // Still throw error for logging purposes
                  });
                }
                return response.json();
              })
              .then((data) => {
                if (data.success) {
                  console.log(
                    "++++++++++++++++data come form update cart++++++++++++"
                  );
                  const quantityElement = document.querySelector(
                    `#quantity-${productId}`
                  );
                  const regularPriceElement= document.querySelector(
                    `#regularPrice-${productId}`
                  );
                  const discountValueElement= document.querySelector(
                    `#discountValue-${productId}`
                  )
                  const totalPriceElement = document.querySelector(
                    `#totalPrice-${productId}`
                  );
                   const sub_totalPriceElement = document.querySelector(
                    '#subtotal'
                   )
                   const totalDiscountValueElement = document.querySelector(
                    '#totalDiscountValue'
                   )
                  const grandTotalElements =
                    document.getElementsByClassName("grandTotal");

                  const totalQuantity = document.getElementById("totalquant");

                  console.log(totalPriceElement + "  " + grandTotalElements);
                  if (quantityElement && totalPriceElement && regularPriceElement && discountValueElement) {
                    const newQuantity =
                      parseInt(quantityElement.innerText) + change;
                    quantityElement.innerHTML = newQuantity;

                    console.log(data);
                     if(data.regularPrice){
                      regularPriceElement.innerHTML = `   
                          <strong>Total Price :</strong> <i
                            class="fa-solid fa-indian-rupee-sign"
                            style="font-size: small; padding-left: 5px; color: #858b85"
                          ></i> ${(newQuantity * data.regularPrice).toFixed(2)}
  `;
                     }else{
                      console.error(
                        "Regular price is missing in the response."
                      );
                     }

                     if(data.discountValue){
                      discountValueElement.innerHTML = `<strong>Discount :</strong> <i
                            class="fa-solid fa-indian-rupee-sign"
                            style="font-size: small; padding-left: 5px; color: #858b85"
                          ></i> ${(newQuantity * data.discountValue).toFixed(2)}`;
                     }else{
                      console.error(
                        "Discount value is missing in the response."
                      );
                     }

                    if (data.productPrice) {
                      totalPriceElement.innerHTML = `<i
                            class="fa-solid fa-indian-rupee-sign"
                            style="font-size: small; padding-left: 5px; color: #282928"
                          ></i> ${(
                        newQuantity * data.productPrice
                      ).toFixed(2)}`
                    } else {
                      console.error(
                        "Product price is missing in the response."
                      );
                    }
                  }

                  if (
                    sub_totalPriceElement &&
                    data.sub_total 
                  ) {                  
                      sub_totalPriceElement.innerHTML = `<i
                        class="fa-solid fa-indian-rupee-sign"
                        style="font-size: medium; padding-left: 5px; color: #28a745"
                      ></i>
                        ${data.sub_total.toFixed(2)}`;
                      console.log("how many times");                  
                  }

                  if(totalDiscountValueElement && data.totalDiscountValue){
                    totalDiscountValueElement.innerHTML =
                     ` <i
                        class="fa-solid fa-indian-rupee-sign"
                        style="font-size: medium; padding-left: 5px; color: #28a745"
                      ></i>
                        ${data.totalDiscountValue.toFixed(2)}`;
                      console.log("how many times");
                  }

                  console.log(grandTotalElements.length);

                  if (
                    grandTotalElements.length > 0 &&
                    data.grandTotal !== undefined
                  ) {
                    for (let i = 0; i < grandTotalElements.length; i++) {
                      grandTotalElements[i].innerHTML =
                      `<i
                        class="fa-solid fa-indian-rupee-sign"
                        style="font-size: medium; padding-left: 5px; color: #28a745"
                      ></i>
                        ${data.grandTotal.toFixed(2)}`;
                      console.log("how many times");
                    }
                  }

                  if (totalQuantity && data.totalQuantity !== undefined) {
                    totalQuantity.innerText = data.totalQuantity;
                  } else {
                    console.error("grand totoal error:", data.error);
                  }
                } else {
                  console.error("Failed to update cart:", data.error);
                  Swal.fire({
                    title: "Failed to Update Cart",
                    text: data.error,
                    icon: "error",
                    confirmButtonText: "OK",
                  });
                }
              });
          } catch (err) {
            console.log("cart update failed" + err.message);
          }
        }, 1000 / 2);
      }

      //delete conforamation
      function confirmDelete(itemId) {
        console.log(
          "=========================================reached the confirm delete========================================"
        );
        // Display a confirmation dialog to the user before deleting the product
        Swal.fire({
          title: `Are you sure?`,
          text: `You want to remove this form cart?`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Yes, Remove it!",
          cancelButtonText: "Cancel",
        }).then((result) => {
          if (result.isConfirmed) {
            // Redirect to delete route
            window.location.href = `/deletecart/${itemId}`;
          }
        });
        return false; // Prevent the default link action
      }
    </script>
  </body>
</html>
